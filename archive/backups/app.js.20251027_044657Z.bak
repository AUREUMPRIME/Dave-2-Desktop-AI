(() => {
  function ready(){
    const q = s => document.querySelector(s);
    const canvas = q("#dos");
    const btn    = q("#start");
    const fpsEl  = q("#fps");
    const agent  = q("#agent");
    if(!canvas || !btn){ console.error("UI missing #dos or #start"); return; }

    btn.disabled = false;
    let started = false;

    function onCiReady(ci, player){
      try{
        console.info("ci-ready");
        window.__dave2 = { player, ci };
        window.dispatchEvent(new CustomEvent("dave2:ci-ready", { detail: { ci, player } }));
        if (agent) agent.textContent = "ON";
        const evs = ci && ci.events ? ci.events() : null;
        if (evs && evs.onFps) evs.onFps(v => { try { fpsEl.textContent = v; } catch(_){ } });
      }catch(_){}
    }

    btn.addEventListener("click", () => {
      if (started) return; started = true; btn.disabled = true;
      try{
        const player = Dos(canvas, {
          url: "/dave2.jsdos",
          pathPrefix: "https://v8.js-dos.com/latest/emulators/",
          onEvent: (event, _ci) => { console.info("event:", event); if (event === "ci-ready") onCiReady(_ci, player); }
        });
        console.info("Dos start");
      }catch(e){
        document.body.innerHTML = "<pre style=\"color:#f55\">API v8 error: " + (e && e.message ? e.message : e) + "</pre>";
      }
    });
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", ready); else ready();
})();
