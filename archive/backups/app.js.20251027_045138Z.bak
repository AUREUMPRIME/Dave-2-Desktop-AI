(() => {
  const q = s => document.querySelector(s);
  const canvas = q("#dos");
  const btn    = q("#start");
  const fpsEl  = q("#fps");
  const agent  = q("#agent");
  if(!canvas || !btn){ console.error("missing #dos or #start"); return; }

  function onCiReady(ci, player){
    console.info("ci-ready");
    try{
      window.__dave2 = { player, ci };
      window.dispatchEvent(new CustomEvent("dave2:ci-ready", { detail: { ci, player } }));
      if (agent) agent.textContent = "ON";
      const evs = ci && ci.events ? ci.events() : null;
      if (evs && evs.onFps) evs.onFps(v => { try { fpsEl.textContent = v; } catch(_){ } });
    }catch(_){}
  }

  btn.disabled = false;
  btn.addEventListener("click", () => {
    (async () => {
      try{
        btn.disabled = true;
        // v8: initialize then run bundle explicitly
        const player = await Dos(canvas, { pathPrefix: "https://v8.js-dos.com/latest/emulators/" });
        console.info("Dos start");
        const ci = await player.run("https://v8.js-dos.com/bundles/digger.jsdos");
        onCiReady(ci, player);
      }catch(e){
        console.error(e);
        document.body.innerHTML = "<pre style=\"color:#f55\">API v8 error: " + (e && e.message ? e.message : e) + "</pre>";
      }
    })();
  });
})();
