(() => {
  const q = s => document.querySelector(s);
  const canvas = q("#dos");
  const btn = q("#start");
  const fpsEl = q("#fps");
  let ci = null;

  btn.addEventListener("click", () => {
    try {
      btn.disabled = true;
      const player = Dos(canvas, {
        url: "/dave2.jsdos",
        pathPrefix: "/vendor/jsdos/emulators/",
        onEvent: (event, _ci) => {
          if (event === "ci-ready") {
            ci = _ci;
            try {
              window.__dave2 = { player, ci };
              window.dispatchEvent(new CustomEvent("dave2:ci-ready", { detail: { ci, player } }));
            } catch (_){}
            const evs = ci && ci.events ? ci.events() : null;
            if (evs && evs.onFps) evs.onFps(v => { try { fpsEl.textContent = v; } catch (_){ } });
          }
        }
      });
    } catch (e) {
      document.body.innerHTML = "<pre style=\"color:#f55\">API v8 error: " + (e && e.message ? e.message : e) + "</pre>";
    }
  });
})();
