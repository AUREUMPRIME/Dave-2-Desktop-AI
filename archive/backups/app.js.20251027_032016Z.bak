(() => {
  const q = s => document.querySelector(s);
  const canvas = q('#dos');
  const btn = q('#start');
  const fpsEl = q('#fps');
  let ci = null;

  btn.addEventListener('click', async () => {
    try{
      btn.disabled = true;
      // IMPORTANTE: Dos(...) devuelve un Promise en v8
      const player = Dos(canvas, { onEvent: (event,_ci)=>{ if(event==="ci-ready"){ try{ ci=_ci; window.__dave2={player,ci}; window.dispatchEvent(new CustomEvent("dave2:ci-ready",{detail:{ci,player}})); }catch(e){} } },  url: "/dave2.jsdos",  pathPrefix: "/vendor/jsdos/emulators/" });
// removed: player.run(...) for v8
    // === AEON: expose CI + event ===
    try {
      window.__dave2 = { player, ci };
      window.dispatchEvent(new CustomEvent('dave2:ci-ready', { detail: { ci, player } }));
    } catch(e) { console.warn('ci-ready dispatch failed', e); }
      if (ev?.onFps) ev.onFps(v => fpsEl.textContent = v);
      ev?.onFrame?.(()=>{}); // no-op, mantiene gancho
    }catch(e){
      document.body.innerHTML = `<pre style="color:#f55">API v8 error: ${e?.message||e}</pre>`;
    }
  });
})();



;window.addEventListener('dave2:ci-ready', (ev) => {
  try {
    const ciReady = ev.detail?.ci;
    const evs = ciReady?.events?.();
    if (evs?.onFps) evs.onFps(v => { try { document.querySelector('#fps').textContent = v; } catch(_){} });
  } catch(e) { console.warn('hook error', e); }
});
